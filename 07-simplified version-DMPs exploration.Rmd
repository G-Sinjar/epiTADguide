---
title: "R Notebook"
output: html_notebook
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 


Add a new chunk by clicking the *Insert Chunk* button on the toolbar or by pressing *Ctrl+Alt+I*.

When you save the notebook, an HTML file containing the code and output will be saved alongside it (click the *Preview* button or press *Ctrl+Shift+K* to preview the HTML file).

The preview shows you a rendered HTML copy of the contents of the editor. Consequently, unlike *Knit*, *Preview* does not run any R code chunks. Instead, the output of the chunk when it was last run in the editor is displayed.



####################################### script ################################
# library
```{r}
library(minfi)
library("IlluminaHumanMethylationEPICv2manifest")
library(openxlsx)
library(dplyr)
library(readxl)
library(ggplot2)
library(plotly)
library(htmlwidgets)
```

# DMP finder prepareing steps
## 1- get beta values, M values and phen
```{r}
beta_values <- read.xlsx("./Output/2-Beta_values_SWAN_0.01.xlsx", rowNames = TRUE)
M_values <- read.xlsx("./Output/3-M_values_SWAN_0.01.xlsx",, rowNames = TRUE)
#View(M_values)

# pheno (used script 2.)
pheno <- pData(ratio_geno_Swan_NoSNP)$Sample_Group

# or
# Convert guide_status to a factor (if it isn't already)
guide_status <- factor(pData(ratio_geno_Swan_0.01_NoSNP)$Sample_Group)
# Change the reference level to "unguided"
guide_status <- relevel(guide_status, ref = "unguided")
```

## 2- compute the beta and M values 
```{r}
########## computing the beta values #############
# Subset the columns for unguided and guided samples
#beta_unguided <- beta_values[, c(1, 3, 5, 7)] 
#beta_guided <- beta_values[, c(2, 4, 6, 8)]   

# Compute row-wise mean for each group
#mean_beta_unguided <- rowMeans(beta_unguided)
#mean_beta_guided <- rowMeans(beta_guided)

# Compute the mean difference (guided - unguided)
#Beta_log2_meanSubstraction <- log2(mean_beta_guided - mean_beta_unguided)    # NAs wurde erzeugt
#Beta_log2mean_Substraction <- log2(mean_beta_guided) - log2(mean_beta_unguided)


########## computing the M values #############
# Subset the columns for unguided and guided samples
M_unguided <- M_values[, c(1, 3, 5, 7)] 
M_guided <- M_values[, c(2, 4, 6, 8)]    

# Compute row-wise mean for each group
mean_M_unguided <- rowMeans(M_unguided)
mean_M_guided <- rowMeans(M_guided)

M_mean_difference <- mean_M_guided - mean_M_unguided

# add M_mean_difference and Beta_mean_difference later to the dmp tables
```


# Finding DMPs to check if the 10 cpgs have a sig. p-value 
```{r}
# 1. try
dmp <- dmpFinder(as.matrix(beta_values), pheno = pheno, type = "categorical", qCutoff = 1, shrinkVar = FALSE) 
#options(scipen = 999)
#View(dmp)

## 2. try with schrink
#dmp_shrink <- dmpFinder(ratio_geno_Swan_0.01_NoSNP_Beta, pheno = pheno, type = "categorical", qCutoff = 1, shrinkVar = TRUE) 
#Warnung: row names of contrasts don't match col names of coefficients
#View(dmp_shrink)
```

# Editing the DMP table
```{r}
################## Add beta_mean_difference #############  change according to dmp table name #################
# 1. Match the row names of dmp with the names in mean_difference
#matching_indices <- match(rownames(dmp), names(mean_difference))
# Check if matching_indices contains any NA values (which means a row wasn't found)
#any(is.na(matching_indices)) # false

#dmp$beta_difference <- mean_difference[matching_indices]

# 3. check it worked
#dmp["cg24426691_TC11", ]$beta_difference  # -0.1545998
#mean_difference["cg24426691_TC11"]        # -0.1545998 

#mean_difference["cg06428163_BC21"]      # -0.2349488 
#dmp["cg06428163_BC21",]$beta_difference #  -0.2349488 



################## Add M_mean_difference #############  change according to dmp table name #################
# 1. Match the row names 
matching_indices_M <- match(rownames(dmp), names(M_mean_difference))

# Check if matching_indices contains any NA values (which means a row wasn't found)
if (any(is.na(matching_indices_M))) {
  print("Warning: Some rows in dmp were not found in mean_difference!") 
} else {
  dmp$M_difference <- M_mean_difference[matching_indices_M]
  print("All rows were found in both tables. M mean difference is added to the dmp table")
}

# 3. check it worked (2 targeted cpgs should be in minus)
dmp["cg24426691_TC11", ]$M_difference  # -1.126752
M_mean_difference["cg24426691_TC11"]   # -1.126752 

M_mean_difference["cg06428163_BC21"]      #  -1.577501
dmp["cg06428163_BC21",]$M_difference      #  -1.577501

View(dmp)
```

# Add GenType column for volcanoplot
```{r}
cpgs_inCLDN10_AB <- read_excel("./Output/6-cpgs_inCLDN10_A+B.xlsx", col_names = TRUE)

# Merge dmp with cpgs_inCLDN10_AB, keeping all rows from dmp
if (!"CpGs" %in% colnames(dmp)) {
  dmp$CpGs <- rownames(dmp)
}

dmp <- merge(dmp, cpgs_inCLDN10_AB[, c("CpGs", "GenType")], by = "CpGs", all.x = TRUE)

# Ersetze NA-Werte in GenType mit "Other"
dmp$GenType[is.na(dmp$GenType)] <- "Other"
  

View(dmp)
```


# Save DMP table as excel 
```{r}
dmp_with_rownames <- cbind(CpGs = rownames(dmp), dmp)
writexl::write_xlsx(dmp_with_rownames, "./Output/7-DMPs_NoShrink_0,01.xlsx")


#dmp <- read_excel("./Output/7-DMPs_NoShrink_0,01.xlsx", col_names = TRUE)
```


#  Volcano plot
```{r}
dim(dmp) #891492      7
# Make sure 'GenType' is a factor
dmp$GenType <- as.factor(dmp$GenType)


# since the html is so slow due to too many cpgs it is better to do a primary filter with pvalue 
# Keep only CpGs with significant p-values or non-"Other" categories
dmp_filtered <- dmp %>% filter(GenType != "Other" | pval < 0.08) 
dim(dmp_filtered) # 65430    7
```


```{r}
create_volcano_plot <- function(dmp_filtered, pval_cutoff , fc_range=c(-0.7, 0.7)) {
  
  y_intercept <- -log10(pval_cutoff)
  x_intercepts <- fc_range
  
  color_palette <- c(
    "CLDN10 Iso-A" = "blue",
    "CLDN10 Iso-B" = "purple",
    "Targeted CpG" = "green",
    "Other" = "gray"
  )
  
  plot_m <- ggplot(dmp_filtered, aes(
    y = -log10(pval),
    x = M_difference,
    color = GenType,
    text = paste0(
      CpGs,
      "<br>FC: ", round(M_difference, 5),
      "<br>p.val: ", round(pval, 5)
    )
  )) +
    geom_point(size = 0.7, alpha = ifelse(dmp_filtered$GenType == "Other", 0.3, 1)) +
    geom_hline(yintercept = y_intercept, linetype = "dashed", color = "red") +
    geom_vline(xintercept = x_intercepts, linetype = "dashed", color = "red") +
    
    annotate("text", x = max(dmp_filtered$M_difference, na.rm = TRUE) * 0.95, y = y_intercept * 0.9,
             label = paste("p-val =", pval_cutoff), hjust = 0, vjust = -1, color = "red", fontface = "bold") +
    
    annotate("text", x = x_intercepts[1] * 0.9, y = min(-log10(dmp_filtered$pval), na.rm = TRUE) * 1.1,
             label = as.character(x_intercepts[1]), hjust = -0.2, vjust = 1.5, color = "red") +
    
    annotate("text", x = x_intercepts[2] * 0.9, y = min(-log10(dmp_filtered$pval), na.rm = TRUE) * 1.1,
             label = as.character(x_intercepts[2]), hjust = 1.2, vjust = 1.5, color = "red") +
    
    labs(x = "FC = logâ‚‚(M/U)", y = "-log10(p-value)", title = "Differentially Methylated Probes") +
    scale_color_manual(values = color_palette) +
    guides(color = guide_legend(title = "CpG Categories")) +
    theme_minimal()
 plot_m
  #ggplotly(plot_m, tooltip = "text")
}

# Remove hover tooltips for "Other" points
#for (i in seq_along(interactive_plot$x$data)) {
#  if ("name" %in% names(interactive_plot$x$data[[i]]) && interactive_plot$x$data[[i]]$name == "Other") {
#    interactive_plot$x$data[[i]]$hoverinfo <- "none"
#  }
#}


#test
create_volcano_plot(dmp_filtered ,0.02, c(-0.7, 0.7))

# Save as an interactive HTML file
#saveWidget(interactive_plot, "./Plots/dmps_CLDN10_colored_filtered_0.02.html", selfcontained = TRUE)
```

# ---- Shiny App ---- very slow dont make any sence
```{r}
volcano_ui <- fluidPage(
  titlePanel("Interactive Volcano Plot Viewer"),
  sidebarLayout(
    sidebarPanel(
      numericInput("pval", "P-value cutoff:", value = 0.02, min = 0.0001, max = 1, step = 0.001),
      sliderInput("fc_range", "Fold change range:", min = -2, max = 2, value = c(-0.7, 0.7), step = 0.01),
      actionButton("submit", "Submit"),
      br(), br(),
      downloadButton("savePlot", "Download Plot as HTML")
    ),
    mainPanel(
      plotlyOutput("volcanoPlot", height = "600px")
    )
  )
)

volcano_server <- function(input, output,session) {
  
  volcano_plot <- eventReactive(input$submit, {
    create_volcano_plot(dmp_filtered, pval_cutoff = input$pval, fc_range = input$fc_range)
  })
  
  #output$volcanoPlot <- renderPlotly({
    #volcano_plot()
  #})
  
  output$savePlot <- downloadHandler(
    filename = function() {
      paste("volcano_plot_", "_pval_", input$pval,"FC[", input$fc_range, "].html", sep = "")
    },
    content = function(file) {
      saveWidget(volcano_plot(), file)
    }
  )
}

shinyApp(volcano_ui, volcano_server)
```