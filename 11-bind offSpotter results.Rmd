---
title: "R Notebook"
output: html_notebook
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Ctrl+Shift+Enter*. 

```{r}
plot(cars)
```

Add a new chunk by clicking the *Insert Chunk* button on the toolbar or by pressing *Ctrl+Alt+I*.

When you save the notebook, an HTML file containing the code and output will be saved alongside it (click the *Preview* button or press *Ctrl+Shift+K* to preview the HTML file).

The preview shows you a rendered HTML copy of the contents of the editor. Consequently, unlike *Knit*, *Preview* does not run any R code chunks. Instead, the output of the chunk when it was last run in the editor is displayed.


```{r}
library(dplyr)
library(readxl)
library(readr)
library(GenomeInfoDb)
library(stringr)
```

# function to read and combine offspotter results
```{r}
'library(readr)
library(dplyr) 
library(stringr) '

read_guide_files <- function(directory_path, guide_file_names) {
  captured_output <- list(messages = character(), warnings = character(), errors = character())
  append_output <- function(type, msg) {
    captured_output[[type]] <<- c(captured_output[[type]], msg)
  }
  
  col_names <- c("Chrom", "Strand", "Start", "End", "Given query", "Actual genomic hit",
                 "Number_of_mismatches", "Pre-mRNA (Unspliced)", "mRNA (5UTR)",
                 "mRNA (CDS)", "mRAN (3UTR)", "lincRNA (Unspliced)",
                 "lincRNA (Spliced)", "GC content")
  
  all_guides <- list()
  
  for (file_name in guide_file_names) {
    full_file_path <- file.path(directory_path, file_name)
    append_output("messages", paste("Processing file:", full_file_path))
    
    guide_data <- tryCatch(
      {
        read_delim(full_file_path, delim = "\t", col_names = FALSE, show_col_types = FALSE)
      },
      error = function(e) {
        err_msg <- paste("Critical Error in reading a file: '", full_file_path, "'. Reason: ", e$message, sep = "")
        append_output("errors", err_msg)
        return(NULL)
      }
    )
    if (is.null(guide_data)) next
    
    if (ncol(guide_data) != length(col_names)) {
      err_msg <- paste("Critical Error: File '", full_file_path, "' has ", ncol(guide_data),
                       " columns, but ", length(col_names), " columns were expected.", sep = "")
      append_output("errors", err_msg)
      next
    }
    
    processed_guide_data <- tryCatch(
      {
        colnames(guide_data) <- col_names
        
        # Remove unwanted column
        guide_data <- guide_data[, !(colnames(guide_data) %in% "GC content")]
        
        # Guide name
        guide_name_for_col <- tools::file_path_sans_ext(file_name)
        guide_data$guide <- guide_name_for_col
        
        # Compute and clean numeric columns
        guide_data$Start <- as.integer(guide_data$Start)
        guide_data$End <- as.integer(guide_data$End)
        guide_data$Start_minus_70 <- guide_data$Start - 70
        guide_data$End_plus_70 <- guide_data$End + 70
        guide_data$Start_minus_70 <- as.integer(guide_data$Start_minus_70)
        guide_data$End_plus_70 <- as.integer(guide_data$End_plus_70)
        guide_data$Number_of_mismatches <- as.integer(guide_data$Number_of_mismatches)
        
        guide_data
      },
      error = function(e) {
        err_msg <- paste("Critical Error: Problem with initial data processing for file '", full_file_path,
                         "'. Check column names or data structure. Reason: ", e$message, sep = "")
        append_output("errors", err_msg)
        return(NULL)
      }
    )
    if (is.null(processed_guide_data)) next
    
    all_guides[[file_name]] <- processed_guide_data
  }
  
  if (length(all_guides) == 0) {
    append_output("errors", "No guide files were successfully processed. Please check paths, file names and contents.")
    return(list(data = NULL, output = captured_output))
  }
  
  combined_guides <- tryCatch(
    {
      bind_rows(all_guides)
    },
    error = function(e) {
      err_msg <- paste("Critical Error: Failed to combine all guide tables. Reason: ", e$message, sep = "")
      append_output("errors", err_msg)
      return(NULL)
    }
  )
  if (is.null(combined_guides)) {
    return(list(data = NULL, output = captured_output))
  }
  
  just_offtargets <- tryCatch(
    {
      combined_guides %>%
        filter(`Number_of_mismatches` != 0) %>%
        mutate(
          guide_num = str_extract(guide, "(?i)guide([[:alnum:]]+)", group = 1),
          ID = paste0("G", guide_num, ".M", `Number_of_mismatches`, ".chr", Chrom, "_", Start)
        ) %>%
        select(-guide_num)
    },
    error = function(e) {
      err_msg <- paste("Critical Error: Failed during off-target filtering or ID generation. Reason: ", e$message, sep = "")
      append_output("errors", err_msg)
      return(NULL)
    }
  )
  if (is.null(just_offtargets)) {
    return(list(data = NULL, output = captured_output))
  }
  
  final_data <- tryCatch(
    {
      just_offtargets %>%
        select(
          ID,
          guide,
          Chrom,
          Start,
          End,
          Number_of_mismatches,
          Start_minus_70,
          End_plus_70,
          everything()
        )
    },
    error = function(e) {
      err_msg <- paste("Critical Error: Failed during final column reordering. Reason: ", e$message, sep = "")
      append_output("errors", err_msg)
      return(NULL)
    }
  )
  if (is.null(final_data)) {
    return(list(data = NULL, output = captured_output))
  }
  
  append_output("messages", "Finished processing all guide files successfully.")
  return(list(data = final_data, output = captured_output))
}

```


# Test function: Path to the offspotter result folder
```{r}
offspoter_result_path <- "C:/Users/ghaza/Documents/ghazal/Bioinformatik_Fächer/Masterarbeit_Project/Results/offspotter_results"

# Read in all the guides (assuming 6 guides)
combined_Offspotter_guideResults <- read_guide_files(offspoter_result_path, c("guide1.txt", "guide2.txt", "guide3.txt", "guide4.txt", "guide5.txt", "guide6.txt"))

View(combined_Offspotter_guideResults$data)
```


# convert to a GRange
```{r}
#from above of from this csv file
combined_Offspotter_guideResults <- read.csv("./Output/offtargets_2025-05-21_newIDs.csv", header = TRUE)


gr_offtargets <- GRanges(
  seqnames = combined_Offspotter_guideResults$Chrom,
  ranges = IRanges(
    start = combined_Offspotter_guideResults$Start_minus_70,
    end = combined_Offspotter_guideResults$End_plus_70
  )
)
mcols(gr_offtargets) <- combined_Offspotter_guideResults[, !(colnames(combined_Offspotter_guideResults) %in% c("Chrom", "Strand", "Start_minus_70", "End_plus_70"))]
seqlevelsStyle(gr_offtargets) <- "UCSC"

gr_offtargets 

mcols(gr_offtargets)
```

# is DMR2-chr7 near offtarget? --> case2 --> no
```{r}
dmrs_df <- read_excel("C:/Users/ghaza/Documents/ghazal/Bioinformatik_Fächer/Masterarbeit_Project/Scripts/R_Scripts/Output/8-DMRs_0.01_smooth.xlsx")
View(dmrs_df)


DMR2_start <- dmrs_df$start[2]
DMR2_chr <- dmrs_df$chr[2]

# Check if DMR2_chr is in the combined guide table and if DMR2_start is within the range
matching_guide <- combined_Offspotter_guides %>%
  filter(Chrom == 7 & DMR2_start >= Start_minus_70 & DMR2_start <= End_plus_70)

# If there is a matching guide, display it
if (nrow(matching_guide) > 0) {
  print("Matching guide found:")
  print(matching_guide)
} else {
  print("No matching offtarget found.")
}
# result: "No matching guide found."
```

# ist DMR2-chr7 in a tad where an offtarget is? -> case3
```{r}
# get tads on chr7
tads_chr7 <-  read_excel("C:\\Users\\ghaza\\Documents\\ghazal\\Bioinformatik_Fächer\\Masterarbeit_Project\\Scripts\\PythonProject\\TADs_CAKI2\\3_TADs_as_txt_and_Excel\\CAKI2_chr7_25000bp_TADs.xlsx", skip = 2)
head(tads_chr7)

tads_chr7 <- tads_chr7 %>%
  mutate(StartPos = as.numeric(StartPos),
         EndPos = as.numeric(EndPos))


# See in which tad is dmr2
gr_tads_chr7 <- GRanges(seqnames = "chr7",
                        ranges = IRanges(start = tads_chr7$StartPos,
                                         end = tads_chr7$EndPos), 
                        TadNr = tads_chr7$TadNr)

gr_tads_chr7


# Filter second DMR (row 2)
dmr_row <- dmrs_df[2, ]  # second DMR

# GRanges for the DMR
gr_dmr <- GRanges(seqnames = dmr_row$chr,
                  ranges = IRanges(start = dmr_row$start,
                                   end = dmr_row$end))

## see if there is an offtarget in the tad where DMR2 is

# Step 1: Find TADs overlapping this DMR
overlap <- findOverlaps(gr_dmr, gr_tads_chr7)

if (length(overlap) > 0) {
  # Get the overlapping TAD(s)
  tad_hit <- gr_tads_chr7[subjectHits(overlap)]
  
  # You can loop through each TAD if needed, but for now assume 1:
  tad_nr <- tad_hit$TadNr[1]  # or loop if multiple
  
  # Step 2: Find off-targets overlapping that same TAD
  overlap_off <- findOverlaps(tad_hit, gr_offtargets)
  
  if (length(overlap_off) > 0) {
    offtargets_in_tad <- gr_offtargets[subjectHits(overlap_off)]
    cat("Off-targets found in the same TAD as DMR:\n")
    print(offtargets_in_tad)
  } else {
    cat("No off-targets found in the same TAD as the DMR.\n")
  }
  
} else {
  cat("No TAD found for this DMR.\n")
}
# result: No off-targets found in the same TAD as the DMR.
```

# DMR3 --> try to create case 2 
```{r}
# cpgs on the chr6 checken --> may be many near DMR3
DMR3_chr <- dmrs_df$chr[3]
DMR3_start <- dmrs_df$start[3]
DMR3_start
DMR3_end <- dmrs_df$end[3]


chr6_cpgs <- (cpgs[cpgs$chr == "chr6", ])

cpgs_indmr3 <- chr6_cpgs[chr6_cpgs$pos >= DMR3_start & chr6_cpgs$pos <= DMR3_end, ]
View(cpgs_indmr3) # alot of cpgs in the near may be can be manipulated

# check if near offtarget
matching_offtarget_dmr3 <- combined_Offspotter_guides %>%
  filter(Chrom == 6 & DMR3_start >= Start_minus_70 & DMR3_start <= End_plus_70)
if (nrow(matching_offtarget_dmr3) > 0) {
  print("Matching guide found:")
  print(matching_offtarget_dmr3)
} else {
  print("No matching offtarget found.")
}
# No matching offtarget found. -->cpgs_indmr3 is not near any Off-target


# check all offtargets on chr6
# choose an offtarget to manipulate the cpgs near it
chr6_offtargets <- combined_Offspotter_guides[combined_Offspotter_guides$Chrom== 6,]
View(chr6_offtargets) # is there an off target near the cpgs_indmr3 out the -70,+70 but near?
```

